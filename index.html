<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Bug ä¿®å¤ç‰ˆ</title>
<style>
body { margin:0; overflow:hidden; background:#000; }
canvas { display:block; cursor:crosshair; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
addEventListener("resize",resize);resize();

// ================= ç©å®¶ =================
let player = { x:0,y:0,speed:2,hp:100,maxHp:100,regen:0 };

// ================= è¾“å…¥ =================
const keys={};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

let mouse={x:0,y:0};
canvas.addEventListener("mousemove",e=>{mouse.x=e.clientX;mouse.y=e.clientY;});

// ================= å·¥å…· =================
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
function dir(){
    const cx=canvas.width/2, cy=canvas.height/2;
    let dx=mouse.x-cx, dy=mouse.y-cy;
    let l=Math.hypot(dx,dy); if(!l)return null;
    return {x:dx/l,y:dy/l};
}
const toScreen=(x,y)=>({x:x-player.x+canvas.width/2,y:y-player.y+canvas.height/2});

// ================= æ•Œäºº =================
const enemies=[];
let spawnT=0;
function spawnEnemy(){
    enemies.push({
        x:player.x+(Math.random()*600-300),
        y:player.y+(Math.random()*600-300),
        hp:60,
        speed:0.6,
        baseSpeed:0.6,
        damage:10,
        burn:0,
        slow:0
    });
}

// ================= æŠ€èƒ½ =================
const swords=[], fireballs=[], ice=[], lightnings=[];

// é£å‰‘
function sword(){
    const d=dir(); if(!d)return;
    swords.push({x:player.x,y:player.y,vx:d.x*9,vy:d.y*9,life:160,damage:10});
}

// âš¡ é—ªç”µ
function lightning(){
    const d=dir(); if(!d)return;
    const pts=[], range=300;
    for(let i=0;i<=10;i++){
        let t=i/10,o=(Math.random()-0.5)*20;
        pts.push({x:player.x+d.x*range*t+d.y*o,y:player.y+d.y*range*t-d.x*o});
    }
    lightnings.push({pts,life:10,damage:50});
}

// ğŸ”¥ ç«çƒ
function fire(){
    const d=dir(); if(!d)return;
    fireballs.push({x:player.x,y:player.y,vx:d.x*4,vy:d.y*4,life:180,damage:20});
}

// â„ å†°é”¥
function iceCone(){
    const d=dir(); if(!d)return;
    const c=5,s=Math.PI/6;
    for(let i=0;i<c;i++){
        let a=-s/2+s*i/(c-1),cs=Math.cos(a),sn=Math.sin(a);
        ice.push({
            x:player.x,y:player.y,
            vx:(d.x*cs-d.y*sn)*5,
            vy:(d.x*sn+d.y*cs)*5,
            life:120,damage:12
        });
    }
}

addEventListener("keydown",e=>{
    if(e.key==="1")sword();
    if(e.key==="2")lightning();
    if(e.key==="3")fire();
    if(e.key==="4")iceCone();
});

// ================= æ›´æ–° =================
function update(){
    if(keys.w)player.y-=player.speed;
    if(keys.s)player.y+=player.speed;
    if(keys.a)player.x-=player.speed;
    if(keys.d)player.x+=player.speed;

    if(++player.regen>=60){
        player.regen=0;
        player.hp=Math.min(100,player.hp+1);
    }

    if(++spawnT>60){spawnT=0;spawnEnemy();}

    for(const e of enemies){
        if(e.burn>0){ e.burn--; if(e.burn%60===0)e.hp-=5; }
        if(e.slow>0){ e.slow--; e.speed=e.baseSpeed*0.4; }
        else e.speed=e.baseSpeed;

        let dx=player.x-e.x,dy=player.y-e.y,l=Math.hypot(dx,dy)||1;
        e.x+=dx/l*e.speed; e.y+=dy/l*e.speed;

        if(dist(e,player)<8) player.hp-=e.damage/60;
    }

    // ç§»åŠ¨ + ç”Ÿå‘½å‘¨æœŸ
    swords.forEach(s=>{s.x+=s.vx;s.y+=s.vy;s.life--;});
    fireballs.forEach(f=>{f.x+=f.vx;f.y+=f.vy;f.life--;});
    ice.forEach(i=>{i.x+=i.vx;i.y+=i.vy;i.life--;});
    lightnings.forEach(l=>l.life--);

    // å‘½ä¸­
    for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i];

        swords.forEach(s=>{ if(dist(e,s)<6)e.hp-=s.damage; });

        for(let j=fireballs.length-1;j>=0;j--){
            if(dist(e,fireballs[j])<10){
                e.hp-=20; e.burn=180;
                fireballs.splice(j,1);
            }
        }

        for(let j=ice.length-1;j>=0;j--){
            if(dist(e,ice[j])<6){
                e.hp-=12; e.slow=120;
                ice.splice(j,1);
            }
        }

        for(const l of lightnings){
            for(const p of l.pts){
                if(dist(e,p)<12){ e.hp-=50; break; }
            }
        }

        if(e.hp<=0) enemies.splice(i,1);
    }

    // âœ… æ­£ç¡®æ¸…ç†
    for(let i=swords.length-1;i>=0;i--) if(swords[i].life<=0) swords.splice(i,1);
    for(let i=fireballs.length-1;i>=0;i--) if(fireballs[i].life<=0) fireballs.splice(i,1);
    for(let i=ice.length-1;i>=0;i--) if(ice[i].life<=0) ice.splice(i,1);
    for(let i=lightnings.length-1;i>=0;i--) if(lightnings[i].life<=0) lightnings.splice(i,1);
}

// ================= ç»˜åˆ¶ =================
function draw(){
    ctx.fillStyle="#111";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // æ•Œäººé«˜äº®
    for(const e of enemies){
        const p=toScreen(e.x,e.y);
        if(e.burn>0) ctx.fillStyle=Math.random()<0.5?"#ff8800":"#ffaa00";
        else if(e.slow>0) ctx.fillStyle="#66ccff";
        else ctx.fillStyle="#00ff66";
        ctx.fillRect(p.x-1,p.y-1,3,3);
    }

    ctx.fillStyle="yellow";
    ctx.fillRect(canvas.width/2-1,canvas.height/2-1,3,3);

    ctx.fillStyle="#ddd";
    swords.forEach(s=>{
        const p=toScreen(s.x,s.y);
        ctx.fillRect(p.x-1,p.y-1,2,2);
    });

    fireballs.forEach(f=>{
        const p=toScreen(f.x,f.y);
        let g=ctx.createRadialGradient(p.x,p.y,1,p.x,p.y,6);
        g.addColorStop(0,"#fff5aa");
        g.addColorStop(1,"#ff5500");
        ctx.fillStyle=g;
        ctx.beginPath();
        ctx.arc(p.x,p.y,5,0,Math.PI*2);
        ctx.fill();
    });

    ctx.fillStyle="#99ddff";
    ice.forEach(i=>{
        const p=toScreen(i.x,i.y);
        ctx.fillRect(p.x-1,p.y-1,2,2);
    });

    ctx.strokeStyle="#66ccff"; ctx.lineWidth=2;
    lightnings.forEach(l=>{
        ctx.beginPath();
        const s=toScreen(l.pts[0].x,l.pts[0].y);
        ctx.moveTo(s.x,s.y);
        l.pts.forEach(p=>{
            const sp=toScreen(p.x,p.y);
            ctx.lineTo(sp.x,sp.y);
        });
        ctx.stroke();
    });

    ctx.fillStyle="red";
    ctx.fillRect(20,20,100,6);
    ctx.fillStyle="lime";
    ctx.fillRect(20,20,player.hp,6);
}

(function loop(){
    update();
    draw();
    requestAnimationFrame(loop);
})();
</script>
</body>
</html>
